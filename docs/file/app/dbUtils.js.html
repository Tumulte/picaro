<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">app/dbUtils.js | javascript-development-environment</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Initial Json for a Node project"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="javascript-development-environment"><meta property="twitter:description" content="Initial Json for a Node project"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/dbUtils.js~RelationHandler.html">RelationHandler</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app/dbUtils.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">var shortid = require(&apos;shortid&apos;);

var filterFromQuery = function filterFromQuery(o, query) {
    for (var property in query) {
        var reqQuery = query[property];
        if (property === &quot;tag_&quot; &amp;&amp; o.tags_) {
            return o.tags_.indexOf(reqQuery) !== -1;
        } else if (query) {
            return o[property] === reqQuery;
        }
    }
    return true;
};
var trimAroundComma = function trimAroundComma(data) {
    if (typeof data === &quot;string&quot;) {
        return data.replace(&quot;, &quot;, &quot;,&quot;).replace(&quot; ,&quot;, &quot;,&quot;);
    }
    return data;
}
/**
 * This is used to get data with its one-to-one relationships.
 * Any field like foo_: bar (mind the &quot;_&quot;) will be replaced by object 
 * identified by the id &quot;bar&quot; from this table &quot;foo&quot;
 */
export class RelationHandler {
    constructor(db, req) {
        this.relationMarker = &quot;_&quot;;
        this.data = {};
        this.db = db;
        this.req = req;

    };
    /**
     * @param {object} _replaceIDByData.data The data from the original query
     * @param {number|string} _replaceIDByData.item The field containing the id to look for
     */
    _replaceIDByData(data, item) {
        var dbQuery = false
        if (data[item] === false) {
            return dbQuery;
        } else if (typeof data[item] === &quot;string&quot;) {
            var table = item.replace(&quot;_&quot;, &quot;s&quot;);
            dbQuery = this.db.get(table).find({
                &quot;id&quot;: data[item]
            }).value();
        } else if (typeof data[item] !== &apos;undefined&apos;) {
            table = item.replace(&quot;_&quot;, &quot;&quot;);
            dbQuery = this.db.get(table).filter(function (o) {
                return data[item].indexOf(o.id) !== -1
            }).value();
        }
        return dbQuery;
    }
    _findRelationnalProperties(data, db) {

        for (var item in data) {
            var lastChar = item.substr(item.length - 1);
            if (data[item] !== null &amp;&amp; typeof data[item] === &quot;object&quot; &amp;&amp; data[item].hasOwnProperty(&quot;id&quot;)) {
                data[item] = this.findRelationnalProperties(data[item], db);
            } else if (lastChar === this.relationMarker) {
                var table = item.replace(&quot;_&quot;, &quot;&quot;);

                data[table] = this._replaceIDByData(data, item);
            }
        }
        return data
    }
    _detachObject(data) {
        data = JSON.parse(JSON.stringify(data));
        return data;
    }

    //Public
    get() {
        if (typeof this.req.params.quoteId !== &quot;undefined&quot;) {
            this.data = this.req.db.get(this.req.params.table).find({
                &quot;id&quot;: this.req.params.quoteId
            }).value();
        } else {
            this.data = db.get(this.req.params.table).filter(function (o) {
                return this._filterFromQuery(o, this.req.query);
            }).value();
        }

        return this;
    }
    getRelations() {
        if (typeof this.data === &quot;undefined&quot;) {
            return this.data = false;
        }
        var data = this._detachObject(this.data);
        data = this._findRelationnalProperties(data, db);
        return data;
    }
}

//POST HANDLER
var dataWriteHandler = function (db, req) {
    var saveNewRelations = function (db, data) {
        data.forEach(function (element) {
            var table = element.type.replace(&quot;_&quot;, &quot;&quot;);
            if (element.hasOwnProperty(&quot;id&quot;) &amp;&amp; element.id) {
                db.get(table).push({
                    id: element.id,
                    name: element.name
                }).write();
            }
        });
    }
    var standardizePostData = function (data) {
        this.data = data;
        this.relations = [];

        this.data[&quot;id&quot;] = shortid.generate();


        var addExistingID = function (item) {
            var attributeName = item.replace(&quot;existing_&quot;, &quot;&quot;);
            this.data[attributeName] = this.data[item];
            delete this.data[item];
            return this;
        };
        var handleNewRelations = function (item) {
            if (this.data[item] === &quot;&quot;) {
                return false;
            } else if (typeof this.data[item] === &quot;string&quot;) {
                this.data[item] = this.data[item].split(&apos;,&apos;);
            }

            var newRelationsID = &quot;&quot;;

            this.data[item].forEach(function (element) {
                var id = shortid.generate();
                newRelationsID += &quot;,&quot; + id;
                this.relations.push({
                    &quot;id&quot;: id,
                    &quot;name&quot;: element.trim(),
                    &quot;type&quot;: item.replace(&quot;new_&quot;, &quot;&quot;)
                });
            });
            return newRelationsID

        };
        var standardizeIdList = function (list) {
            if (list.charAt(0) === &apos;,&apos;) {
                list = list.slice(1);
            }
            list = trimAroundComma(list);
            return list.split(&apos;,&apos;);
        }

        var populateRelations = function () {
            for (var item in data) {
                if (item.indexOf(&quot;existing_&quot;) !== -1) {
                    addExistingID(item);
                }
            }
            for (item in data) {
                if (item.indexOf(&quot;new_&quot;) !== -1) {
                    var attributeName = item.replace(&quot;new_&quot;, &quot;&quot;);
                    if (!this.data[attributeName] &amp;&amp; this.data[item] === &quot;&quot;) {
                        this.data[attributeName] = false;
                    } else {
                        var relations = handleNewRelations(item);
                        var idList = this.data[attributeName] += relations;
                        this.data[attributeName] = standardizeIdList(idList);
                    }

                    delete this.data[item];

                }
            }
            return this
        }

        populateRelations();
        return this;
    }


    this.save = function () {
        var data = standardizePostData(req.body);
        db.get(req.params.table).push(
            data.data
        ).write();
        saveNewRelations(db, data.relations);
        return data;
    }
}

module.exports = {
    &quot;dataHandler&quot;: dataHandler,
    &quot;dataWriteHandler&quot;: dataWriteHandler
};</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
